name: Check File Deploy 2025
on:
  workflow_dispatch: # Allows manual triggering from the Actions tab
    inputs:
      check-file:
        description: 'CHECK FILE'
        type: string
        required: true
        default: ''
      DEVICE_TREE:
        description: 'DEVICE TREE'
        required: true
        default: 'https://github.com/Tec4Sho/android_device_alps_tb8163p3_bsp.git'
      DEVICE_TREE_BRANCH:
        description: 'DEVICE TREE BRANCH'
        required: true
        default: 'android-9.0'
      DEVICE_PATH:
        description: 'DEVICE PATH'
        required: true
        default: 'device/alps/tb8163p3_bsp'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:      
      - name: Create Workspace
        run: |
          mkdir -p ${GITHUB_WORKSPACE}/workspace
          set -o allexport
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          if [[ `which git` ]]; then
          echo -e "\n`git --version`\n";
          git config --global core.longpaths true
          git config --global core.protectNTFS false
          git config --global http.postBuffer 524288000 # Increase post buffer size (example value in bytes)
          git config --global http.lowSpeedLimit 0      # Disable low speed limit
          git config --global http.lowSpeedTime 999999  # Increase low speed time threshold
          else
          echo -e "\nGit needed installing now....\n";
          sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -yq git >/dev/null;
          git config --global core.longpaths true
          git config --global core.protectNTFS false
          git config --global http.postBuffer 524288000 # Increase post buffer size (example value in bytes)
          git config --global http.lowSpeedLimit 0      # Disable low speed limit
          git config --global http.lowSpeedTime 999999  # Increase low speed time threshold
          fi
          set +e
        continue-on-error: true

      - name: Check Workspace 1
        run: |
          du . -h -d 4

    # Setup triple clone start
      - name: Clone Kernel Repo
        if: steps.restore-workspace-cache.outputs.cache-hit != 'true' && env.PREBUILT_KERNEL == 'false'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.actor }}/android_kernel_mt8163
          path: ./workspace/kernel/alps/tb8163p3_bsp
          ref: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}

      - name: Clone Recovery Repo
        if: steps.restore-workspace-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: ./workspace/${{ github.event.inputs.DEVICE_PATH }}
          ref: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}

      - name: Check Workspace 2
        run: |
          du . -h -d 8
          
      - name: Check File
        if: inputs.check-file != ''
        uses: Tec4Sho/check-file-action@master
        with:
          filename: ${{ inputs.check-file }}
          dirname: workspace
          rootdir: false
          content: true
          include: true
        continue-on-error: true
